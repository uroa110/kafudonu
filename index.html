<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUKU_BAKERY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 to-amber-50 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-orange-800 mb-2">üßÅ PUKU_BAKERY</h1>
            <p class="text-gray-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö ‡∏™‡∏π‡∏ï‡∏£ ‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£</p>
        </div>

        <!-- Navigation -->
        <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
            <div class="flex flex-wrap gap-2">
                <button onclick="showSection('purchase')" class="nav-btn bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition-colors">
                    üõí ‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö
                </button>
                <button onclick="showSection('ingredients')" class="nav-btn bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                    üõí ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö
                </button>
                <button onclick="showSection('inventory')" class="nav-btn bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                    üì¶ ‡∏Ñ‡∏•‡∏±‡∏á
                </button>
                <button onclick="showSection('recipes')" class="nav-btn bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors">
                    üìë ‡∏™‡∏π‡∏ï‡∏£
                </button>
                <button onclick="showSection('production')" class="nav-btn bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition-colors">
                    üë©‚Äçüç≥ ‡∏ú‡∏•‡∏¥‡∏ï
                </button>
                <button onclick="showSection('sales')" class="nav-btn bg-pink-500 text-white px-4 py-2 rounded-lg hover:bg-pink-600 transition-colors">
                    üõçÔ∏è ‡∏Ç‡∏≤‡∏¢
                </button>
                <button onclick="showSection('reports')" class="nav-btn bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition-colors">
                    üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                </button>
            </div>
        </div>

        <!-- Purchase Section -->
        <div id="purchase" class="section bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-teal-800 mb-4">üõí ‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-teal-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-teal-800 mb-3">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h3>
                    <div class="space-y-3">
                        <select id="purchaseIngredient" class="w-full p-2 border rounded-lg">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</option>
                        </select>
                        <input type="number" id="purchaseQuantity" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠ (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ã‡∏∑‡πâ‡∏≠)" class="w-full p-2 border rounded-lg">
                        <div id="purchasePreview" class="bg-white p-3 rounded border min-h-20">
                            <div class="text-sm text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
                        </div>
                        <button onclick="makePurchase()" class="w-full bg-teal-500 text-white p-2 rounded-lg hover:bg-teal-600">
                            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠
                        </button>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-800 mb-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h3>
                    <div id="purchaseHistory" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- Purchase history will be listed here -->
                    </div>
                    <div class="mt-4 p-3 bg-white rounded-lg">
                        <div class="text-lg font-semibold text-teal-800">
                            ‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: <span id="todayPurchaseTotal" class="text-teal-600">0</span> ‡∏ö‡∏≤‡∏ó
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ingredients Section -->
        <div id="ingredients" class="section bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
            <h2 class="text-2xl font-bold text-blue-800 mb-4">üõí ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-blue-800 mb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏´‡∏°‡πà</h3>
                    <div class="space-y-3">
                        <div class="relative">
                            <input type="text" id="ingredientName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö" class="w-full p-2 border rounded-lg">
                        </div>
                        <div class="relative">
                            <input type="text" id="ingredientUnit" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö (‡∏Å‡∏£‡∏±‡∏°/‡∏•‡∏¥‡∏ï‡∏£/‡∏ä‡∏¥‡πâ‡∏ô)" class="w-full p-2 border rounded-lg">
                        </div>
                        <div class="relative">
                            <input type="text" id="ingredientPurchaseUnit" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ñ‡∏∏‡∏á/‡∏Å‡∏¥‡πÇ‡∏•/‡∏Ç‡∏ß‡∏î)" class="w-full p-2 border rounded-lg">
                        </div>
                        <input type="number" id="ingredientConversionRate" placeholder="1 ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ã‡∏∑‡πâ‡∏≠ = ? ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö (‡πÄ‡∏ä‡πà‡∏ô 1000)" class="w-full p-2 border rounded-lg">
                        <input type="number" id="ingredientQuantity" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠ (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ã‡∏∑‡πâ‡∏≠)" class="w-full p-2 border rounded-lg">
                        <input type="number" id="ingredientTotalPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° (‡πÄ‡∏ä‡πà‡∏ô 35)" class="w-full p-2 border rounded-lg">
                        <div id="pricePerUnit" class="bg-gray-100 p-2 rounded-lg text-center text-gray-600 min-h-10 flex items-center justify-center">
                            ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
                        </div>
                        <button onclick="addIngredient()" class="w-full bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö
                        </button>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-800 mb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h3>
                    <div id="ingredientsList" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- Ingredients will be listed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Section -->
        <div id="inventory" class="section bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
            <h2 class="text-2xl font-bold text-green-800 mb-4">üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h2>
            
            <div class="bg-green-50 p-4 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="inventoryGrid">
                    <!-- Inventory items will be displayed here -->
                </div>
                <div class="mt-4 p-3 bg-white rounded-lg">
                    <div class="text-lg font-semibold text-green-800">
                        ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏°: <span id="totalInventoryValue" class="text-green-600">0</span> ‡∏ö‡∏≤‡∏ó
                    </div>
                </div>
            </div>
        </div>

        <!-- Recipes Section -->
        <div id="recipes" class="section bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
            <h2 class="text-2xl font-bold text-purple-800 mb-4">üìë ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ï‡∏£</h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-purple-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-purple-800 mb-3">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà</h3>
                    <div class="space-y-3">
                        <div class="relative">
                            <input type="text" id="recipeName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" class="w-full p-2 border rounded-lg">
                        </div>
                        <input type="number" id="recipeYield" placeholder="‡πÑ‡∏î‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ä‡∏¥‡πâ‡∏ô)" class="w-full p-2 border rounded-lg">
                        
                        <!-- Base Recipe Selection -->
                        <div class="bg-blue-50 p-3 rounded-lg border-2 border-blue-200">
                            <h4 class="font-medium text-blue-800 mb-2">üéØ ‡πÉ‡∏ä‡πâ‡∏™‡∏π‡∏ï‡∏£‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</h4>
                            <select id="baseRecipe" class="w-full p-2 border rounded-lg mb-2">
                                <option value="">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            </select>
                            <button onclick="loadBaseRecipe()" class="w-full bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600">
                                ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏π‡∏ï‡∏£‡∏´‡∏•‡∏±‡∏Å
                            </button>
                        </div>
                        
                        <div class="border-t pt-3">
                            <h4 class="font-medium mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏ô‡∏™‡∏π‡∏ï‡∏£:</h4>
                            <select id="recipeIngredient" class="w-full p-2 border rounded-lg mb-2">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</option>
                            </select>
                            <input type="number" id="recipeIngredientAmount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ" class="w-full p-2 border rounded-lg mb-2">
                            <button onclick="addIngredientToRecipe()" class="w-full bg-purple-400 text-white p-2 rounded-lg hover:bg-purple-500">
                                ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö
                            </button>
                        </div>
                        
                        <div id="recipeIngredients" class="bg-white p-3 rounded border min-h-20">
                            <div class="text-sm text-gray-500">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏ô‡∏™‡∏π‡∏ï‡∏£‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
                        </div>
                        
                        <div class="flex gap-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="isBaseRecipe" class="mr-2">
                                <span class="text-sm">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏π‡∏ï‡∏£‡∏´‡∏•‡∏±‡∏Å</span>
                            </label>
                        </div>
                        
                        <button onclick="saveRecipe()" class="w-full bg-purple-500 text-white p-2 rounded-lg hover:bg-purple-600">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏π‡∏ï‡∏£
                        </button>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-800 mb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ï‡∏£</h3>
                    <div class="mb-3">
                        <div class="flex gap-2">
                            <button onclick="filterRecipes('all')" class="filter-btn bg-gray-200 px-3 py-1 rounded text-sm hover:bg-gray-300">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                            <button onclick="filterRecipes('base')" class="filter-btn bg-blue-200 px-3 py-1 rounded text-sm hover:bg-blue-300">‡∏™‡∏π‡∏ï‡∏£‡∏´‡∏•‡∏±‡∏Å</button>
                            <button onclick="filterRecipes('variation')" class="filter-btn bg-green-200 px-3 py-1 rounded text-sm hover:bg-green-300">‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏õ‡∏£‡∏ú‡∏±‡∏ô</button>
                        </div>
                    </div>
                    <div id="recipesList" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- Recipes will be listed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Production Section -->
        <div id="production" class="section bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-orange-800">üë©‚Äçüç≥ ‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</h2>
                <div class="bg-blue-50 px-3 py-1 rounded-lg text-sm">
                    <span class="text-blue-600">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô 5:00 ‡∏ô.</span>
                    <div class="text-xs text-gray-500" id="resetCountdown">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                </div>
            </div>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-orange-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-orange-800 mb-3">‡∏ú‡∏•‡∏¥‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    <div class="space-y-3">
                        <select id="productionRecipe" class="w-full p-2 border rounded-lg">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏π‡∏ï‡∏£</option>
                        </select>
                        <input type="number" id="productionPieces" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï" class="w-full p-2 border rounded-lg">
                        <div id="productionPreview" class="bg-white p-3 rounded border min-h-20">
                            <div class="text-sm text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
                        </div>
                        <button onclick="startProduction()" class="w-full bg-orange-500 text-white p-2 rounded-lg hover:bg-orange-600">
                            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏¥‡∏ï
                        </button>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-800 mb-3">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢</h3>
                    <div id="finishedProducts" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- Finished products will be listed here -->
                    </div>
                </div>
            </div>
        </div>



        <!-- Sales Section -->
        <div id="sales" class="section bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
            <h2 class="text-2xl font-bold text-pink-800 mb-4">üõçÔ∏è ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-pink-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-pink-800 mb-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3>
                    <div class="space-y-3">
                        <select id="saleProduct" class="w-full p-2 border rounded-lg">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
                        </select>
                        <input type="number" id="remainingQuantity" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠" class="w-full p-2 border rounded-lg">
                        <div class="relative">
                            <input type="number" id="salePrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô" class="w-full p-2 border rounded-lg">
                        </div>
                        <div id="salePreview" class="bg-white p-3 rounded border">
                            <div class="text-sm text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
                        </div>
                        <button onclick="recordSale()" class="w-full bg-pink-500 text-white p-2 rounded-lg hover:bg-pink-600">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
                        </button>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-800 mb-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h3>
                    <div id="salesHistory" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- Sales history will be listed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports" class="section bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
            <h2 class="text-2xl font-bold text-indigo-800 mb-4">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>
            
            <!-- Report Period Selection -->
            <div class="bg-indigo-50 p-4 rounded-lg mb-6">
                <h3 class="font-semibold text-indigo-800 mb-3">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h3>
                <div class="flex flex-wrap gap-2 mb-4">
                    <button onclick="setReportPeriod('today')" class="report-period-btn bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
                    <button onclick="setReportPeriod('week')" class="report-period-btn bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</button>
                    <button onclick="setReportPeriod('month')" class="report-period-btn bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
                    <button onclick="setReportPeriod('custom')" class="report-period-btn bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</button>
                </div>
                
                <!-- Custom Date Range -->
                <div id="customDateRange" class="hidden grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                        <input type="date" id="startDate" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                        <input type="date" id="endDate" class="w-full p-2 border rounded-lg">
                    </div>
                </div>
                
                <div class="mt-3 text-sm text-indigo-600" id="reportPeriodText">
                    ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                </div>
            </div>
            
            <!-- Summary Cards -->
            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-green-100 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-green-800" id="totalRevenue">0</div>
                    <div class="text-green-600">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</div>
                </div>
                <div class="bg-red-100 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-red-800" id="totalCost">0</div>
                    <div class="text-red-600">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</div>
                </div>
                <div class="bg-blue-100 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-800" id="totalProfit">0</div>
                    <div class="text-blue-600">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏ö‡∏≤‡∏ó)</div>
                </div>
                <div class="bg-purple-100 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-purple-800" id="profitMargin">0%</div>
                    <div class="text-purple-600">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£</div>
                </div>
            </div>
            
            <!-- Detailed Reports -->
            <div class="grid lg:grid-cols-2 gap-6">
                <!-- Product Performance -->
                <div class="bg-indigo-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-indigo-800 mb-3">üìà ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    <div id="productPerformance" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Product performance will be listed here -->
                    </div>
                </div>
                
                <!-- Sales Summary -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-800 mb-3">üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3>
                    <div id="salesSummary" class="space-y-2">
                        <!-- Sales summary will be shown here -->
                    </div>
                </div>
            </div>
            
            <!-- Production vs Sales Chart -->
            <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
                <h3 class="font-semibold text-yellow-800 mb-3">üè≠ ‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï vs ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3>
                <div id="productionVsSales" class="space-y-3">
                    <!-- Production vs sales data will be shown here -->
                </div>
            </div>
            
            <!-- Daily Breakdown (for week/month periods) -->
            <div id="dailyBreakdown" class="mt-6 bg-teal-50 p-4 rounded-lg hidden">
                <h3 class="font-semibold text-teal-800 mb-3">üìÖ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
                <div id="dailyBreakdownContent" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- Daily breakdown will be shown here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let ingredients = JSON.parse(localStorage.getItem('ingredients') || '[]');
        let recipes = JSON.parse(localStorage.getItem('recipes') || '[]');
        let finishedProducts = JSON.parse(localStorage.getItem('finishedProducts') || '[]');
        let sales = JSON.parse(localStorage.getItem('sales') || '[]');
        let purchases = JSON.parse(localStorage.getItem('purchases') || '[]');
        let productionHistory = JSON.parse(localStorage.getItem('productionHistory') || '[]');
        let currentRecipeIngredients = [];
        let currentReportPeriod = 'today';
        let editingRecipeIndex = -1;
        let isEditMode = false;

        // Autocomplete data storage
        let autocompleteData = JSON.parse(localStorage.getItem('autocompleteData') || '{}');
        if (!autocompleteData.ingredientNames) autocompleteData.ingredientNames = [];
        if (!autocompleteData.units) autocompleteData.units = ['‡∏Å‡∏£‡∏±‡∏°', '‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°', '‡∏•‡∏¥‡∏ï‡∏£', '‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏•‡∏¥‡∏ï‡∏£', '‡∏ä‡∏¥‡πâ‡∏ô', '‡πÉ‡∏ö', '‡∏ü‡∏≠‡∏á', '‡∏ä‡πâ‡∏≠‡∏ô‡∏ä‡∏≤', '‡∏ä‡πâ‡∏≠‡∏ô‡πÇ‡∏ï‡πä‡∏∞', '‡∏ñ‡πâ‡∏ß‡∏¢'];
        if (!autocompleteData.purchaseUnits) autocompleteData.purchaseUnits = ['‡∏ñ‡∏∏‡∏á', '‡∏Å‡∏¥‡πÇ‡∏•', '‡∏Ç‡∏ß‡∏î', '‡∏Å‡∏•‡πà‡∏≠‡∏á', '‡πÅ‡∏û‡πá‡∏Ñ', '‡∏•‡∏±‡∏á', '‡∏´‡∏•‡∏≠‡∏î', '‡∏ã‡∏≠‡∏á'];
        if (!autocompleteData.recipeNames) autocompleteData.recipeNames = [];
        if (!autocompleteData.salePrices) autocompleteData.salePrices = [];

        // Autocomplete functionality
        function setupAutocomplete(inputId, dataArray) {
            const input = document.getElementById(inputId);
            if (!input) return;

            let currentSuggestions = [];
            let selectedIndex = -1;
            let suggestionBox = null;

            function createSuggestionBox() {
                suggestionBox = document.createElement('div');
                suggestionBox.className = 'absolute z-50 bg-white border border-gray-300 rounded-lg shadow-lg max-h-40 overflow-y-auto w-full';
                suggestionBox.style.top = input.offsetHeight + 'px';
                suggestionBox.style.left = '0px';
                
                const container = input.parentElement;
                if (container.style.position !== 'relative') {
                    container.style.position = 'relative';
                }
                container.appendChild(suggestionBox);
            }

            function showSuggestions(suggestions) {
                if (!suggestionBox) createSuggestionBox();
                
                suggestionBox.innerHTML = '';
                currentSuggestions = suggestions;
                selectedIndex = -1;

                if (suggestions.length === 0) {
                    suggestionBox.style.display = 'none';
                    return;
                }

                suggestions.forEach((suggestion, index) => {
                    const item = document.createElement('div');
                    item.className = 'px-3 py-2 cursor-pointer hover:bg-blue-50 text-sm';
                    item.textContent = suggestion;
                    item.onclick = () => selectSuggestion(suggestion);
                    suggestionBox.appendChild(item);
                });

                suggestionBox.style.display = 'block';
            }

            function selectSuggestion(suggestion) {
                input.value = suggestion;
                hideSuggestions();
                input.focus();
                input.dispatchEvent(new Event('input'));
            }

            function hideSuggestions() {
                if (suggestionBox) {
                    suggestionBox.style.display = 'none';
                }
                selectedIndex = -1;
            }

            function updateSelection() {
                if (!suggestionBox) return;
                
                const items = suggestionBox.children;
                for (let i = 0; i < items.length; i++) {
                    items[i].classList.remove('bg-blue-100');
                    if (i === selectedIndex) {
                        items[i].classList.add('bg-blue-100');
                    }
                }
            }

            input.addEventListener('input', function() {
                const value = this.value.toLowerCase().trim();
                if (value.length === 0) {
                    hideSuggestions();
                    return;
                }

                const filtered = dataArray.filter(item => 
                    item.toLowerCase().includes(value) && item.toLowerCase() !== value
                ).slice(0, 8);

                showSuggestions(filtered);
            });

            input.addEventListener('keydown', function(e) {
                if (!suggestionBox || suggestionBox.style.display === 'none') return;

                switch(e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        selectedIndex = Math.min(selectedIndex + 1, currentSuggestions.length - 1);
                        updateSelection();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        selectedIndex = Math.max(selectedIndex - 1, -1);
                        updateSelection();
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (selectedIndex >= 0) {
                            selectSuggestion(currentSuggestions[selectedIndex]);
                        }
                        break;
                    case 'Escape':
                        hideSuggestions();
                        break;
                }
            });

            input.addEventListener('blur', function() {
                setTimeout(hideSuggestions, 150);
            });

            input.addEventListener('focus', function() {
                if (this.value.trim().length > 0) {
                    this.dispatchEvent(new Event('input'));
                }
            });
        }

        function addToAutocomplete(category, value) {
            if (!value || value.trim() === '') return;
            
            const trimmedValue = value.trim();
            if (!autocompleteData[category].includes(trimmedValue)) {
                autocompleteData[category].push(trimmedValue);
                if (autocompleteData[category].length > 50) {
                    autocompleteData[category] = autocompleteData[category].slice(-50);
                }
                localStorage.setItem('autocompleteData', JSON.stringify(autocompleteData));
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            showSection('purchase');
            checkDailyReset();
            updateAllDisplays();
            startDailyResetTimer();
            
            // Setup autocomplete for all relevant fields
            setupAutocomplete('ingredientName', autocompleteData.ingredientNames);
            setupAutocomplete('ingredientUnit', autocompleteData.units);
            setupAutocomplete('ingredientPurchaseUnit', autocompleteData.purchaseUnits);
            setupAutocomplete('recipeName', autocompleteData.recipeNames);
            setupAutocomplete('salePrice', autocompleteData.salePrices);
        });

        // Navigation
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionName).classList.remove('hidden');
            
            // Update displays when switching sections
            if (sectionName === 'inventory') updateInventoryDisplay();
            if (sectionName === 'recipes') updateRecipeSelects();
            if (sectionName === 'production') updateProductionSelects();
            if (sectionName === 'purchase') updatePurchaseSelects();
            if (sectionName === 'sales') updateSalesSelects();
            if (sectionName === 'reports') updateReports();
        }

        // Ingredients Management
        function addIngredient() {
            const name = document.getElementById('ingredientName').value;
            const unit = document.getElementById('ingredientUnit').value;
            const purchaseUnit = document.getElementById('ingredientPurchaseUnit').value;
            const conversionRate = parseFloat(document.getElementById('ingredientConversionRate').value);
            const purchaseQuantity = parseFloat(document.getElementById('ingredientQuantity').value);
            const totalPrice = parseFloat(document.getElementById('ingredientTotalPrice').value);

            if (!name || !unit || !purchaseUnit || !conversionRate || !purchaseQuantity || !totalPrice) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }

            // Add to autocomplete data
            addToAutocomplete('ingredientNames', name);
            addToAutocomplete('units', unit);
            addToAutocomplete('purchaseUnits', purchaseUnit);

            // Convert to base unit (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö)
            const actualQuantity = purchaseQuantity * conversionRate;
            const pricePerUnit = totalPrice / actualQuantity;

            const existingIndex = ingredients.findIndex(ing => ing.name === name);
            if (existingIndex >= 0) {
                // Calculate weighted average price for existing ingredient
                const existingTotal = ingredients[existingIndex].quantity * ingredients[existingIndex].price;
                const newTotal = totalPrice;
                const combinedQuantity = ingredients[existingIndex].quantity + actualQuantity;
                const averagePrice = (existingTotal + newTotal) / combinedQuantity;
                
                ingredients[existingIndex].quantity = combinedQuantity;
                ingredients[existingIndex].price = averagePrice;
            } else {
                ingredients.push({ 
                    name, 
                    unit, 
                    purchaseUnit, 
                    conversionRate, 
                    price: pricePerUnit, 
                    quantity: actualQuantity 
                });
            }

            saveData();
            updateAllDisplays();
            clearIngredientForm();
        }

        function clearIngredientForm() {
            document.getElementById('ingredientName').value = '';
            document.getElementById('ingredientUnit').value = '';
            document.getElementById('ingredientPurchaseUnit').value = '';
            document.getElementById('ingredientConversionRate').value = '';
            document.getElementById('ingredientQuantity').value = '';
            document.getElementById('ingredientTotalPrice').value = '';
            document.getElementById('pricePerUnit').innerHTML = '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà';
        }

        function updateIngredientsDisplay() {
            const list = document.getElementById('ingredientsList');
            list.innerHTML = ingredients.map(ing => `
                <div class="bg-white p-3 rounded border flex justify-between items-center">
                    <div>
                        <div class="font-medium">${ing.name}</div>
                        <div class="text-sm text-gray-600">${ing.quantity} ${ing.unit} @ ${ing.price.toFixed(4)} ‡∏ö‡∏≤‡∏ó/${ing.unit}</div>
                        ${ing.purchaseUnit ? `<div class="text-xs text-gray-500">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ã‡∏∑‡πâ‡∏≠: ${ing.purchaseUnit} (1 ${ing.purchaseUnit} = ${ing.conversionRate} ${ing.unit})</div>` : ''}
                    </div>
                    <button onclick="removeIngredient('${ing.name}')" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function removeIngredient(name) {
            if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö ${name} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                ingredients = ingredients.filter(ing => ing.name !== name);
                saveData();
                updateAllDisplays();
            }
        }

        // Inventory Display
        function updateInventoryDisplay() {
            const grid = document.getElementById('inventoryGrid');
            const totalValue = ingredients.reduce((sum, ing) => sum + (ing.quantity * ing.price), 0);
            
            grid.innerHTML = ingredients.map(ing => `
                <div class="bg-white p-4 rounded-lg border">
                    <div class="font-semibold text-gray-800">${ing.name}</div>
                    <div class="text-lg font-bold text-green-600">${ing.quantity} ${ing.unit}</div>
                    <div class="text-sm text-gray-600">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤: ${(ing.quantity * ing.price).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
                    <div class="text-xs text-gray-500">‡∏£‡∏≤‡∏Ñ‡∏≤: ${ing.price} ‡∏ö‡∏≤‡∏ó/${ing.unit}</div>
                </div>
            `).join('');
            
            document.getElementById('totalInventoryValue').textContent = totalValue.toLocaleString();
        }

        // Recipe Management
        function updateRecipeSelects() {
            const select = document.getElementById('recipeIngredient');
            select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</option>' + 
                ingredients.map(ing => `<option value="${ing.name}">${ing.name} (${ing.unit})</option>`).join('');
            
            // Update base recipe select
            const baseSelect = document.getElementById('baseRecipe');
            const baseRecipes = recipes.filter(recipe => recipe.isBase);
            baseSelect.innerHTML = '<option value="">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' + 
                baseRecipes.map((recipe, index) => `<option value="${recipes.indexOf(recipe)}">${recipe.name} (‡∏™‡∏π‡∏ï‡∏£‡∏´‡∏•‡∏±‡∏Å)</option>`).join('');
        }

        function loadBaseRecipe() {
            const baseRecipeIndex = document.getElementById('baseRecipe').value;
            if (baseRecipeIndex === '') {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏´‡∏•‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const baseRecipe = recipes[baseRecipeIndex];
            if (!baseRecipe) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏π‡∏ï‡∏£‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
                return;
            }

            // Load base recipe ingredients
            currentRecipeIngredients = [...baseRecipe.ingredients.map(ing => ({...ing}))];
            
            // Set yield to same as base recipe
            document.getElementById('recipeYield').value = baseRecipe.yield;
            
            updateRecipeIngredientsDisplay();
            alert(`‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏π‡∏ï‡∏£‡∏´‡∏•‡∏±‡∏Å "${baseRecipe.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ`);
        }

        function addIngredientToRecipe() {
            const ingredientName = document.getElementById('recipeIngredient').value;
            const amount = parseFloat(document.getElementById('recipeIngredientAmount').value);

            if (!ingredientName || !amount) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô');
                return;
            }

            const ingredient = ingredients.find(ing => ing.name === ingredientName);
            if (!ingredient) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ô‡∏µ‡πâ');
                return;
            }

            const existingIndex = currentRecipeIngredients.findIndex(ing => ing.name === ingredientName);
            if (existingIndex >= 0) {
                currentRecipeIngredients[existingIndex].amount = amount;
            } else {
                currentRecipeIngredients.push({
                    name: ingredientName,
                    amount: amount,
                    unit: ingredient.unit,
                    price: ingredient.price
                });
            }

            updateRecipeIngredientsDisplay();
            document.getElementById('recipeIngredient').value = '';
            document.getElementById('recipeIngredientAmount').value = '';
        }

        function updateRecipeIngredientsDisplay() {
            const container = document.getElementById('recipeIngredients');
            const totalCost = currentRecipeIngredients.reduce((sum, ing) => sum + (ing.amount * ing.price), 0);
            
            container.innerHTML = currentRecipeIngredients.map(ing => `
                <div class="flex justify-between items-center py-1 border-b">
                    <div class="flex-1">
                        <span>${ing.name}: </span>
                        <input type="number" 
                               value="${ing.amount}" 
                               onchange="updateIngredientAmount('${ing.name}', this.value)"
                               class="w-16 px-1 py-0 text-sm border rounded text-center"
                               step="0.1"
                               min="0.1">
                        <span> ${ing.unit}</span>
                    </div>
                    <div>
                        <span class="text-sm text-gray-600">${(ing.amount * ing.price).toFixed(2)} ‡∏ö‡∏≤‡∏ó</span>
                        <button onclick="removeRecipeIngredient('${ing.name}')" class="ml-2 text-red-500 hover:text-red-700">√ó</button>
                    </div>
                </div>
            `).join('') + `
                <div class="pt-2 font-semibold">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°: ${totalCost.toFixed(2)} ‡∏ö‡∏≤‡∏ó</div>
            `;
        }

        function updateIngredientAmount(name, newAmount) {
            const amount = parseFloat(newAmount);
            if (amount <= 0) {
                alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
                updateRecipeIngredientsDisplay(); // Reset display
                return;
            }
            
            const ingredient = currentRecipeIngredients.find(ing => ing.name === name);
            if (ingredient) {
                ingredient.amount = amount;
                updateRecipeIngredientsDisplay();
            }
        }

        function removeRecipeIngredient(name) {
            if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö ${name} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                currentRecipeIngredients = currentRecipeIngredients.filter(ing => ing.name !== name);
                updateRecipeIngredientsDisplay();
            }
        }

        function saveRecipe() {
            const name = document.getElementById('recipeName').value;
            const yield = parseInt(document.getElementById('recipeYield').value);
            const isBase = document.getElementById('isBaseRecipe').checked;
            const baseRecipeIndex = document.getElementById('baseRecipe').value;

            if (!name || !yield || currentRecipeIngredients.length === 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }

            // Add to autocomplete data
            addToAutocomplete('recipeNames', name);

            const totalCost = currentRecipeIngredients.reduce((sum, ing) => sum + (ing.amount * ing.price), 0);
            const costPerUnit = totalCost / yield;

            const recipe = {
                name,
                yield,
                ingredients: [...currentRecipeIngredients],
                totalCost,
                costPerUnit,
                isBase: isBase,
                baseRecipeIndex: baseRecipeIndex !== '' ? parseInt(baseRecipeIndex) : null,
                baseRecipeName: baseRecipeIndex !== '' ? recipes[baseRecipeIndex].name : null
            };

            if (isEditMode && editingRecipeIndex >= 0) {
                // Update existing recipe
                const oldName = recipes[editingRecipeIndex].name;
                recipes[editingRecipeIndex] = recipe;
                
                // Update any variations that reference this recipe
                recipes.forEach((r, index) => {
                    if (r.baseRecipeIndex === editingRecipeIndex) {
                        r.baseRecipeName = recipe.name;
                    }
                });
                
                saveData();
                updateRecipesDisplay();
                updateRecipeSelects();
                cancelEdit(); // Exit edit mode
                
                const recipeType = isBase ? '‡∏™‡∏π‡∏ï‡∏£‡∏´‡∏•‡∏±‡∏Å' : (baseRecipeIndex !== '' ? '‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏õ‡∏£‡∏ú‡∏±‡∏ô' : '‡∏™‡∏π‡∏ï‡∏£‡∏õ‡∏Å‡∏ï‡∏¥');
                alert(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï${recipeType} "${name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
            } else {
                // Create new recipe
                recipes.push(recipe);
                
                saveData();
                updateRecipesDisplay();
                updateRecipeSelects();
                clearRecipeForm();
                
                const recipeType = isBase ? '‡∏™‡∏π‡∏ï‡∏£‡∏´‡∏•‡∏±‡∏Å' : (baseRecipeIndex !== '' ? '‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏õ‡∏£‡∏ú‡∏±‡∏ô' : '‡∏™‡∏π‡∏ï‡∏£‡∏õ‡∏Å‡∏ï‡∏¥');
                alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å${recipeType} "${name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
            }
        }

        function clearRecipeForm() {
            document.getElementById('recipeName').value = '';
            document.getElementById('recipeYield').value = '';
            document.getElementById('baseRecipe').value = '';
            document.getElementById('isBaseRecipe').checked = false;
            currentRecipeIngredients = [];
            updateRecipeIngredientsDisplay();
            
            // Reset edit mode variables
            isEditMode = false;
            editingRecipeIndex = -1;
            
            // Remove cancel button if exists
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) {
                cancelBtn.remove();
            }
            
            // Reset form appearance
            const saveButton = document.querySelector('button[onclick="saveRecipe()"]');
            if (saveButton) {
                saveButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏π‡∏ï‡∏£';
                saveButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                saveButton.classList.add('bg-purple-500', 'hover:bg-purple-600');
                
                const formContainer = saveButton.closest('.bg-green-50');
                if (formContainer) {
                    formContainer.classList.remove('bg-green-50', 'border-2', 'border-green-300');
                    formContainer.classList.add('bg-purple-50');
                    
                    const formTitle = formContainer.querySelector('h3');
                    formTitle.innerHTML = '<span class="text-purple-800">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà</span>';
                }
            }
        }

        let currentRecipeFilter = 'all';

        function filterRecipes(filter) {
            currentRecipeFilter = filter;
            updateRecipesDisplay();
            
            // Update button styles
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-200');
            });
            event.target.classList.remove('bg-gray-200');
            event.target.classList.add('bg-blue-500', 'text-white');
        }

        function updateRecipesDisplay() {
            const list = document.getElementById('recipesList');
            let filteredRecipes = recipes;
            
            if (currentRecipeFilter === 'base') {
                filteredRecipes = recipes.filter(recipe => recipe.isBase);
            } else if (currentRecipeFilter === 'variation') {
                filteredRecipes = recipes.filter(recipe => recipe.baseRecipeIndex !== null);
            }
            
            list.innerHTML = filteredRecipes.map((recipe, index) => {
                const actualIndex = recipes.indexOf(recipe);
                const recipeTypeIcon = recipe.isBase ? 'üéØ' : (recipe.baseRecipeIndex !== null ? 'üé®' : 'üìù');
                const recipeTypeText = recipe.isBase ? '‡∏™‡∏π‡∏ï‡∏£‡∏´‡∏•‡∏±‡∏Å' : (recipe.baseRecipeIndex !== null ? `‡πÅ‡∏õ‡∏£‡∏ú‡∏±‡∏ô‡∏à‡∏≤‡∏Å: ${recipe.baseRecipeName}` : '‡∏™‡∏π‡∏ï‡∏£‡∏õ‡∏Å‡∏ï‡∏¥');
                
                return `
                    <div class="bg-white p-3 rounded border ${recipe.isBase ? 'border-blue-300 bg-blue-50' : (recipe.baseRecipeIndex !== null ? 'border-green-300 bg-green-50' : '')}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-semibold flex items-center gap-2">
                                    ${recipeTypeIcon} ${recipe.name}
                                </div>
                                <div class="text-xs text-gray-500 mb-1">${recipeTypeText}</div>
                                <div class="text-sm text-gray-600">‡πÑ‡∏î‡πâ: ${recipe.yield} ‡∏ä‡∏¥‡πâ‡∏ô</div>
                                <div class="text-sm text-gray-600">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô: ${recipe.costPerUnit.toFixed(2)} ‡∏ö‡∏≤‡∏ó</div>
                                <div class="text-xs text-gray-500 mt-1">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö: ${recipe.ingredients.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="editRecipe(${actualIndex})" class="text-green-500 hover:text-green-700 text-sm" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
                                <button onclick="duplicateRecipe(${actualIndex})" class="text-blue-500 hover:text-blue-700 text-sm" title="‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏ô‡∏≤">üìã</button>
                                <button onclick="removeRecipe(${actualIndex})" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('') || '<div class="text-gray-500 text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</div>';
        }

        function editRecipe(index) {
            const recipe = recipes[index];
            if (!recipe) return;
            
            // Set edit mode
            isEditMode = true;
            editingRecipeIndex = index;
            
            // Load recipe data into form
            document.getElementById('recipeName').value = recipe.name;
            document.getElementById('recipeYield').value = recipe.yield;
            document.getElementById('isBaseRecipe').checked = recipe.isBase;
            
            // Set base recipe if it's a variation
            if (recipe.baseRecipeIndex !== null) {
                document.getElementById('baseRecipe').value = recipe.baseRecipeIndex;
            } else {
                document.getElementById('baseRecipe').value = '';
            }
            
            // Load ingredients
            currentRecipeIngredients = [...recipe.ingredients.map(ing => ({...ing}))];
            updateRecipeIngredientsDisplay();
            
            // Update save button text
            const saveButton = document.querySelector('button[onclick="saveRecipe()"]');
            saveButton.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏π‡∏ï‡∏£';
            saveButton.classList.remove('bg-purple-500', 'hover:bg-purple-600');
            saveButton.classList.add('bg-green-500', 'hover:bg-green-600');
            
            // Add cancel button
            if (!document.getElementById('cancelEditBtn')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.id = 'cancelEditBtn';
                cancelBtn.textContent = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
                cancelBtn.className = 'w-full bg-gray-500 text-white p-2 rounded-lg hover:bg-gray-600 mt-2';
                cancelBtn.onclick = cancelEdit;
                saveButton.parentNode.insertBefore(cancelBtn, saveButton.nextSibling);
            }
            
            // Show edit indicator
            const formContainer = saveButton.closest('.bg-purple-50');
            formContainer.classList.remove('bg-purple-50');
            formContainer.classList.add('bg-green-50', 'border-2', 'border-green-300');
            
            const formTitle = formContainer.querySelector('h3');
            formTitle.innerHTML = `<span class="text-green-800">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏π‡∏ï‡∏£: ${recipe.name}</span>`;
            
            alert(`‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏π‡∏ï‡∏£ "${recipe.name}"\n‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÑ‡∏î‡πâ`);
        }
        
        function cancelEdit() {
            isEditMode = false;
            editingRecipeIndex = -1;
            clearRecipeForm();
            
            // Reset save button
            const saveButton = document.querySelector('button[onclick="saveRecipe()"]');
            saveButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏π‡∏ï‡∏£';
            saveButton.classList.remove('bg-green-500', 'hover:bg-green-600');
            saveButton.classList.add('bg-purple-500', 'hover:bg-purple-600');
            
            // Remove cancel button
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) {
                cancelBtn.remove();
            }
            
            // Reset form appearance
            const formContainer = saveButton.closest('.bg-green-50');
            if (formContainer) {
                formContainer.classList.remove('bg-green-50', 'border-2', 'border-green-300');
                formContainer.classList.add('bg-purple-50');
                
                const formTitle = formContainer.querySelector('h3');
                formTitle.innerHTML = '<span class="text-purple-800">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà</span>';
            }
        }

        function duplicateRecipe(index) {
            const recipe = recipes[index];
            if (!recipe) return;
            
            const newName = prompt(`‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà:`, `${recipe.name} (‡∏™‡∏≥‡πÄ‡∏ô‡∏≤)`);
            if (!newName) return;
            
            // Create duplicate with new name
            const duplicatedRecipe = {
                ...recipe,
                name: newName,
                isBase: false, // Duplicated recipes are not base recipes by default
                baseRecipeIndex: recipe.isBase ? index : recipe.baseRecipeIndex, // If duplicating a base recipe, set it as base
                baseRecipeName: recipe.isBase ? recipe.name : recipe.baseRecipeName
            };
            
            recipes.push(duplicatedRecipe);
            saveData();
            updateRecipesDisplay();
            updateRecipeSelects();
            alert(`‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏™‡∏π‡∏ï‡∏£ "${newName}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
        }

        function removeRecipe(index) {
            const recipe = recipes[index];
            const hasVariations = recipes.some(r => r.baseRecipeIndex === index);
            
            let confirmMessage = `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏π‡∏ï‡∏£ "${recipe.name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`;
            if (hasVariations) {
                confirmMessage += '\n\n‚ö†Ô∏è ‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏õ‡∏£‡∏ú‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á ‡∏´‡∏≤‡∏Å‡∏•‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏õ‡∏£‡∏ú‡∏±‡∏ô‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏π‡∏ï‡∏£‡∏õ‡∏Å‡∏ï‡∏¥';
            }
            
            if (confirm(confirmMessage)) {
                // Update variations that reference this recipe
                recipes.forEach(r => {
                    if (r.baseRecipeIndex === index) {
                        r.baseRecipeIndex = null;
                        r.baseRecipeName = null;
                    } else if (r.baseRecipeIndex > index) {
                        r.baseRecipeIndex--; // Adjust index after deletion
                    }
                });
                
                recipes.splice(index, 1);
                saveData();
                updateRecipesDisplay();
                updateRecipeSelects();
            }
        }

        // Production Management
        function updateProductionSelects() {
            const select = document.getElementById('productionRecipe');
            select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏π‡∏ï‡∏£</option>' + 
                recipes.map((recipe, index) => `<option value="${index}">${recipe.name}</option>`).join('');
            
            select.onchange = updateProductionPreview;
        }

        function updateProductionPreview() {
            const recipeIndex = document.getElementById('productionRecipe').value;
            const pieces = parseInt(document.getElementById('productionPieces').value) || 0;
            const preview = document.getElementById('productionPreview');

            if (recipeIndex === '') {
                preview.innerHTML = '<div class="text-sm text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>';
                return;
            }

            const recipe = recipes[recipeIndex];
            const batchesNeeded = pieces / recipe.yield;
            const canProduce = checkCanProduce(recipe, batchesNeeded);
            const totalCostFromRecipe = pieces * recipe.costPerUnit;
            
            preview.innerHTML = `
                <div class="space-y-2">
                    <div class="font-semibold">${recipe.name}</div>
                    <div class="bg-blue-50 p-2 rounded">
                        <div class="text-sm text-blue-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏™‡∏π‡∏ï‡∏£:</div>
                        <div class="text-sm">‚Ä¢ ‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡πÑ‡∏î‡πâ ${recipe.yield} ‡∏ä‡∏¥‡πâ‡∏ô</div>
                        <div class="text-sm">‚Ä¢ ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô: ${recipe.costPerUnit.toFixed(2)} ‡∏ö‡∏≤‡∏ó</div>
                    </div>
                    <div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï: ${pieces} ‡∏ä‡∏¥‡πâ‡∏ô</div>
                    <div>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°: ${totalCostFromRecipe.toFixed(2)} ‡∏ö‡∏≤‡∏ó (${recipe.costPerUnit.toFixed(2)} √ó ${pieces})</div>
                    <div class="text-sm ${canProduce ? 'text-green-600' : 'text-red-600'}">
                        ${canProduce ? '‚úÖ ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠' : '‚ùå ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠'}
                    </div>
                    ${!canProduce ? `
                        <div class="text-xs text-red-500 bg-red-50 p-2 rounded">
                            ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ${batchesNeeded.toFixed(2)} ‡∏ä‡∏∏‡∏î‡∏™‡∏π‡∏ï‡∏£ ‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function checkCanProduce(recipe, batches) {
            return recipe.ingredients.every(recipeIng => {
                const ingredient = ingredients.find(ing => ing.name === recipeIng.name);
                return ingredient && ingredient.quantity >= (recipeIng.amount * batches);
            });
        }

        function startProduction() {
            const recipeIndex = document.getElementById('productionRecipe').value;
            const pieces = parseInt(document.getElementById('productionPieces').value);

            if (recipeIndex === '' || !pieces || pieces <= 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï');
                return;
            }

            const recipe = recipes[recipeIndex];
            const batchesNeeded = pieces / recipe.yield;
            
            if (!checkCanProduce(recipe, batchesNeeded)) {
                alert('‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï');
                return;
            }

            // Deduct ingredients based on the proportion needed
            recipe.ingredients.forEach(recipeIng => {
                const ingredient = ingredients.find(ing => ing.name === recipeIng.name);
                ingredient.quantity -= (recipeIng.amount * batchesNeeded);
            });

            // Record production history
            const production = {
                productName: recipe.name,
                quantity: pieces,
                costPerUnit: recipe.costPerUnit,
                totalCost: pieces * recipe.costPerUnit,
                date: new Date().toISOString()
            };
            productionHistory.push(production);

            // Add finished product with cost per unit from recipe (not recalculated)
            const existingProduct = finishedProducts.find(p => p.name === recipe.name);
            if (existingProduct) {
                // Use weighted average if different cost per unit
                const totalQuantity = existingProduct.quantity + pieces;
                const totalCost = (existingProduct.quantity * existingProduct.costPerUnit) + (pieces * recipe.costPerUnit);
                existingProduct.costPerUnit = totalCost / totalQuantity;
                existingProduct.quantity = totalQuantity;
            } else {
                finishedProducts.push({
                    name: recipe.name,
                    quantity: pieces,
                    costPerUnit: recipe.costPerUnit // Use cost from recipe, not recalculated
                });
            }

            saveData();
            updateAllDisplays();
            alert(`‡∏ú‡∏•‡∏¥‡∏ï ${recipe.name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÑ‡∏î‡πâ ${pieces} ‡∏ä‡∏¥‡πâ‡∏ô\n‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô: ${recipe.costPerUnit.toFixed(2)} ‡∏ö‡∏≤‡∏ó (‡∏à‡∏≤‡∏Å‡∏™‡∏π‡∏ï‡∏£)`);
            
            // Clear form
            document.getElementById('productionRecipe').value = '';
            document.getElementById('productionPieces').value = '';
            updateProductionPreview();
        }

        function updateFinishedProductsDisplay() {
            const container = document.getElementById('finishedProducts');
            container.innerHTML = finishedProducts.map((product, index) => `
                <div class="bg-white p-3 rounded border flex justify-between items-center">
                    <div>
                        <div class="font-medium">${product.name}</div>
                        <div class="text-sm text-gray-600">${product.quantity} ‡∏ä‡∏¥‡πâ‡∏ô</div>
                        <div class="text-xs text-gray-500">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô: ${product.costPerUnit.toFixed(2)} ‡∏ö‡∏≤‡∏ó/‡∏ä‡∏¥‡πâ‡∏ô</div>
                    </div>
                    <button onclick="removeFinishedProduct(${index})" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function removeFinishedProduct(index) {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                finishedProducts.splice(index, 1);
                saveData();
                updateFinishedProductsDisplay();
            }
        }

        // Purchase Management
        function updatePurchaseSelects() {
            const select = document.getElementById('purchaseIngredient');
            select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</option>' + 
                ingredients.map((ingredient, index) => `<option value="${index}">${ingredient.name} (${ingredient.unit})</option>`).join('');
            
            select.onchange = updatePurchasePreview;
            updatePurchaseHistory();
        }

        function updatePurchasePreview() {
            const ingredientIndex = document.getElementById('purchaseIngredient').value;
            const purchaseQuantity = parseFloat(document.getElementById('purchaseQuantity').value) || 0;
            const preview = document.getElementById('purchasePreview');

            if (ingredientIndex === '') {
                preview.innerHTML = '<div class="text-sm text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>';
                return;
            }

            const ingredient = ingredients[ingredientIndex];
            const actualQuantity = purchaseQuantity * (ingredient.conversionRate || 1);
            const pricePerPurchaseUnit = ingredient.price * (ingredient.conversionRate || 1);
            const totalCost = purchaseQuantity * pricePerPurchaseUnit;
            
            preview.innerHTML = `
                <div class="space-y-2">
                    <div class="font-semibold">${ingredient.name}</div>
                    ${ingredient.purchaseUnit ? `
                        <div class="text-sm bg-blue-50 p-2 rounded">
                            <div>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ã‡∏∑‡πâ‡∏≠: ${ingredient.purchaseUnit}</div>
                            <div>1 ${ingredient.purchaseUnit} = ${ingredient.conversionRate} ${ingredient.unit}</div>
                            <div>‡∏£‡∏≤‡∏Ñ‡∏≤: ${pricePerPurchaseUnit.toFixed(2)} ‡∏ö‡∏≤‡∏ó/${ingredient.purchaseUnit}</div>
                        </div>
                        <div class="text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠: ${purchaseQuantity} ${ingredient.purchaseUnit}</div>
                        <div class="text-sm">‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö: ${actualQuantity} ${ingredient.unit}</div>
                    ` : `
                        <div class="text-sm">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢: ${ingredient.price.toFixed(4)} ‡∏ö‡∏≤‡∏ó/${ingredient.unit}</div>
                        <div class="text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠: ${purchaseQuantity} ${ingredient.unit}</div>
                    `}
                    <div class="text-lg font-bold text-teal-600">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: ${totalCost.toFixed(2)} ‡∏ö‡∏≤‡∏ó</div>
                    <div class="text-sm text-gray-600">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${ingredient.quantity} ${ingredient.unit}</div>
                    <div class="text-sm text-green-600">‡∏´‡∏•‡∏±‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏∞‡∏°‡∏µ: ${(ingredient.quantity + actualQuantity).toFixed(2)} ${ingredient.unit}</div>
                </div>
            `;
        }

        function makePurchase() {
            const ingredientIndex = document.getElementById('purchaseIngredient').value;
            const purchaseQuantity = parseFloat(document.getElementById('purchaseQuantity').value);

            if (ingredientIndex === '' || !purchaseQuantity || purchaseQuantity <= 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠');
                return;
            }

            const ingredient = ingredients[ingredientIndex];
            const actualQuantity = purchaseQuantity * (ingredient.conversionRate || 1);
            const pricePerPurchaseUnit = ingredient.price * (ingredient.conversionRate || 1);
            const totalCost = purchaseQuantity * pricePerPurchaseUnit;

            // Record purchase
            const purchase = {
                ingredientName: ingredient.name,
                purchaseQuantity: purchaseQuantity,
                purchaseUnit: ingredient.purchaseUnit || ingredient.unit,
                actualQuantity: actualQuantity,
                unit: ingredient.unit,
                pricePerUnit: ingredient.price,
                pricePerPurchaseUnit: pricePerPurchaseUnit,
                totalCost: totalCost,
                date: new Date().toISOString()
            };

            purchases.push(purchase);

            // Update ingredient quantity
            ingredient.quantity += actualQuantity;

            saveData();
            updateAllDisplays();
            
            const purchaseUnitText = ingredient.purchaseUnit || ingredient.unit;
            const actualUnitText = ingredient.purchaseUnit ? ` (${actualQuantity} ${ingredient.unit})` : '';
            alert(`‡∏ã‡∏∑‡πâ‡∏≠ ${ingredient.name} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${purchaseQuantity} ${purchaseUnitText}${actualUnitText} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: ${totalCost.toFixed(2)} ‡∏ö‡∏≤‡∏ó`);
            
            // Clear form
            document.getElementById('purchaseIngredient').value = '';
            document.getElementById('purchaseQuantity').value = '';
            updatePurchasePreview();
        }

        function updatePurchaseHistory() {
            const today = new Date().toDateString();
            const todayPurchases = purchases.filter(purchase => new Date(purchase.date).toDateString() === today);
            
            const container = document.getElementById('purchaseHistory');
            const totalToday = todayPurchases.reduce((sum, purchase) => sum + purchase.totalCost, 0);
            
            container.innerHTML = todayPurchases.map(purchase => `
                <div class="bg-white p-3 rounded border">
                    <div class="font-medium">${purchase.ingredientName}</div>
                    <div class="text-sm text-gray-600">
                        ${purchase.purchaseQuantity || purchase.quantity} ${purchase.purchaseUnit || purchase.unit}
                        ${purchase.actualQuantity && purchase.actualQuantity !== purchase.purchaseQuantity ? ` (${purchase.actualQuantity} ${purchase.unit})` : ''}
                        = ${purchase.totalCost.toFixed(2)} ‡∏ö‡∏≤‡∏ó
                    </div>
                    <div class="text-xs text-gray-500">
                        ${new Date(purchase.date).toLocaleTimeString('th-TH')}
                    </div>
                </div>
            `).join('') || '<div class="text-gray-500 text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';
            
            document.getElementById('todayPurchaseTotal').textContent = totalToday.toLocaleString();
        }

        // Sales Management
        function updateSalesSelects() {
            const select = document.getElementById('saleProduct');
            select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>' + 
                finishedProducts.map((product, index) => `<option value="${index}">${product.name} (${product.quantity} ‡∏ä‡∏¥‡πâ‡∏ô)</option>`).join('');
            
            select.onchange = updateSalePreview;
        }

        function updateSalePreview() {
            const productIndex = document.getElementById('saleProduct').value;
            const remainingQuantity = parseInt(document.getElementById('remainingQuantity').value) || 0;
            const price = parseFloat(document.getElementById('salePrice').value) || 0;
            const preview = document.getElementById('salePreview');

            if (productIndex === '') {
                preview.innerHTML = '<div class="text-sm text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>';
                return;
            }

            const product = finishedProducts[productIndex];
            const soldQuantity = product.quantity - remainingQuantity;
            const revenue = soldQuantity * price;
            const cost = soldQuantity * product.costPerUnit;
            const profit = revenue - cost;
            
            if (remainingQuantity > product.quantity) {
                preview.innerHTML = `
                    <div class="space-y-1">
                        <div class="font-semibold">${product.name}</div>
                        <div class="text-sm text-red-600">‚ùå ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</div>
                        <div class="text-sm">‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà: ${product.quantity} ‡∏ä‡∏¥‡πâ‡∏ô</div>
                    </div>
                `;
                return;
            }
            
            preview.innerHTML = `
                <div class="space-y-1">
                    <div class="font-semibold">${product.name}</div>
                    <div class="text-sm bg-blue-50 p-2 rounded">
                        <div>‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà: ${product.quantity} ‡∏ä‡∏¥‡πâ‡∏ô</div>
                        <div>‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${remainingQuantity} ‡∏ä‡∏¥‡πâ‡∏ô</div>
                        <div class="font-semibold text-blue-600">‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ: ${soldQuantity} ‡∏ä‡∏¥‡πâ‡∏ô</div>
                    </div>
                    ${soldQuantity > 0 ? `
                        <div class="text-sm">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ: ${revenue.toFixed(2)} ‡∏ö‡∏≤‡∏ó</div>
                        <div class="text-sm">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô: ${cost.toFixed(2)} ‡∏ö‡∏≤‡∏ó</div>
                        <div class="text-sm font-semibold ${profit >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ‡∏Å‡∏≥‡πÑ‡∏£: ${profit.toFixed(2)} ‡∏ö‡∏≤‡∏ó
                        </div>
                    ` : '<div class="text-sm text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</div>'}
                </div>
            `;
        }

        function recordSale() {
            const productIndex = document.getElementById('saleProduct').value;
            const remainingQuantity = parseInt(document.getElementById('remainingQuantity').value);
            const price = parseFloat(document.getElementById('salePrice').value);

            if (productIndex === '' || remainingQuantity === undefined || !price) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }

            const product = finishedProducts[productIndex];
            
            if (remainingQuantity > product.quantity) {
                alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà');
                return;
            }

            const soldQuantity = product.quantity - remainingQuantity;
            
            if (soldQuantity <= 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà)');
                return;
            }

            // Add to autocomplete data
            addToAutocomplete('salePrices', price.toString());

            // Record sale
            const sale = {
                productName: product.name,
                quantity: soldQuantity,
                price,
                revenue: soldQuantity * price,
                cost: soldQuantity * product.costPerUnit,
                profit: (soldQuantity * price) - (soldQuantity * product.costPerUnit),
                date: new Date().toISOString()
            };

            sales.push(sale);

            // Update product quantity to remaining amount
            product.quantity = remainingQuantity;
            if (product.quantity === 0) {
                finishedProducts.splice(productIndex, 1);
            }

            saveData();
            updateAllDisplays();
            alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ ${product.name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ: ${soldQuantity} ‡∏ä‡∏¥‡πâ‡∏ô\n‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${remainingQuantity} ‡∏ä‡∏¥‡πâ‡∏ô`);
            
            // Clear form
            document.getElementById('saleProduct').value = '';
            document.getElementById('remainingQuantity').value = '';
            document.getElementById('salePrice').value = '';
            updateSalePreview();
        }

        function updateSalesHistory() {
            const today = new Date().toDateString();
            const todaySales = sales.filter(sale => new Date(sale.date).toDateString() === today);
            
            const container = document.getElementById('salesHistory');
            container.innerHTML = todaySales.map(sale => `
                <div class="bg-white p-3 rounded border">
                    <div class="font-medium">${sale.productName}</div>
                    <div class="text-sm text-gray-600">
                        ${sale.quantity} ‡∏ä‡∏¥‡πâ‡∏ô √ó ${sale.price} ‡∏ö‡∏≤‡∏ó = ${sale.revenue} ‡∏ö‡∏≤‡∏ó
                    </div>
                    <div class="text-sm ${sale.profit >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ‡∏Å‡∏≥‡πÑ‡∏£: ${sale.profit.toFixed(2)} ‡∏ö‡∏≤‡∏ó
                    </div>
                </div>
            `).join('') || '<div class="text-gray-500 text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';
        }

        // Report Period Management
        function setReportPeriod(period) {
            currentReportPeriod = period;
            
            // Update button styles
            document.querySelectorAll('.report-period-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-500', 'text-white');
                btn.classList.add('bg-gray-200');
            });
            event.target.classList.remove('bg-gray-200');
            event.target.classList.add('bg-indigo-500', 'text-white');
            
            // Show/hide custom date range
            const customRange = document.getElementById('customDateRange');
            if (period === 'custom') {
                customRange.classList.remove('hidden');
                // Set default dates
                const today = new Date();
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);
                document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
                document.getElementById('endDate').value = today.toISOString().split('T')[0];
            } else {
                customRange.classList.add('hidden');
            }
            
            updateReportPeriodText();
            updateReports();
        }
        
        function updateReportPeriodText() {
            const periodText = document.getElementById('reportPeriodText');
            let text = '';
            
            switch(currentReportPeriod) {
                case 'today':
                    text = '‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
                    break;
                case 'week':
                    text = '‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ (‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå)';
                    break;
                case 'month':
                    text = '‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ';
                    break;
                case 'custom':
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    if (startDate && endDate) {
                        text = `‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ${formatThaiDate(startDate)} - ${formatThaiDate(endDate)}`;
                    } else {
                        text = '‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)';
                    }
                    break;
            }
            
            periodText.textContent = text;
        }
        
        function formatThaiDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        function getDateRange() {
            const now = new Date();
            let startDate, endDate;
            
            switch(currentReportPeriod) {
                case 'today':
                    startDate = new Date(now);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(now);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                case 'week':
                    // Get Monday of current week
                    const monday = new Date(now);
                    const day = monday.getDay();
                    const diff = monday.getDate() - day + (day === 0 ? -6 : 1);
                    monday.setDate(diff);
                    monday.setHours(0, 0, 0, 0);
                    
                    startDate = monday;
                    endDate = new Date(monday);
                    endDate.setDate(endDate.getDate() + 6);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                case 'custom':
                    const startInput = document.getElementById('startDate').value;
                    const endInput = document.getElementById('endDate').value;
                    if (!startInput || !endInput) return null;
                    
                    startDate = new Date(startInput);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(endInput);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                default:
                    return null;
            }
            
            return { startDate, endDate };
        }
        
        function filterDataByDateRange(data, dateField = 'date') {
            const range = getDateRange();
            if (!range) return [];
            
            return data.filter(item => {
                const itemDate = new Date(item[dateField]);
                return itemDate >= range.startDate && itemDate <= range.endDate;
            });
        }
        
        // Reports
        function updateReports() {
            const filteredSales = filterDataByDateRange(sales);
            const filteredProduction = filterDataByDateRange(productionHistory);
            
            const totalRevenue = filteredSales.reduce((sum, sale) => sum + sale.revenue, 0);
            const totalCost = filteredSales.reduce((sum, sale) => sum + sale.cost, 0);
            const totalProfit = totalRevenue - totalCost;
            const profitMargin = totalRevenue > 0 ? ((totalProfit / totalRevenue) * 100) : 0;
            
            // Update summary cards
            document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString();
            document.getElementById('totalCost').textContent = totalCost.toLocaleString();
            document.getElementById('totalProfit').textContent = totalProfit.toLocaleString();
            document.getElementById('profitMargin').textContent = profitMargin.toFixed(1) + '%';
            
            updateProductPerformance(filteredSales, filteredProduction);
            updateSalesSummary(filteredSales);
            updateProductionVsSales(filteredSales, filteredProduction);
            updateDailyBreakdown(filteredSales, filteredProduction);
        }
        
        function updateProductPerformance(salesData, productionData) {
            // Calculate production totals by product
            const productionTotals = {};
            productionData.forEach(prod => {
                if (!productionTotals[prod.productName]) {
                    productionTotals[prod.productName] = 0;
                }
                productionTotals[prod.productName] += prod.quantity;
            });
            
            // Calculate sales totals by product
            const salesTotals = {};
            const salesRevenue = {};
            const salesProfit = {};
            
            salesData.forEach(sale => {
                if (!salesTotals[sale.productName]) {
                    salesTotals[sale.productName] = 0;
                    salesRevenue[sale.productName] = 0;
                    salesProfit[sale.productName] = 0;
                }
                salesTotals[sale.productName] += sale.quantity;
                salesRevenue[sale.productName] += sale.revenue;
                salesProfit[sale.productName] += sale.profit;
            });
            
            // Combine all products
            const allProducts = new Set([...Object.keys(productionTotals), ...Object.keys(salesTotals)]);
            
            const performanceData = Array.from(allProducts).map(productName => {
                const produced = productionTotals[productName] || 0;
                const sold = salesTotals[productName] || 0;
                const revenue = salesRevenue[productName] || 0;
                const profit = salesProfit[productName] || 0;
                const sellRate = produced > 0 ? ((sold / produced) * 100) : 0;
                
                return {
                    name: productName,
                    produced,
                    sold,
                    revenue,
                    profit,
                    sellRate
                };
            }).sort((a, b) => b.revenue - a.revenue);
            
            const container = document.getElementById('productPerformance');
            container.innerHTML = performanceData.map(product => `
                <div class="bg-white p-4 rounded-lg border">
                    <div class="flex justify-between items-start mb-2">
                        <div class="font-semibold text-gray-800">${product.name}</div>
                        <div class="text-right">
                            <div class="text-lg font-bold ${product.sellRate >= 80 ? 'text-green-600' : product.sellRate >= 50 ? 'text-yellow-600' : 'text-red-600'}">
                                ${product.sellRate.toFixed(1)}%
                            </div>
                            <div class="text-xs text-gray-500">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <div class="text-gray-600">‡∏ú‡∏•‡∏¥‡∏ï: <span class="font-medium">${product.produced}</span> ‡∏ä‡∏¥‡πâ‡∏ô</div>
                            <div class="text-gray-600">‡∏Ç‡∏≤‡∏¢: <span class="font-medium">${product.sold}</span> ‡∏ä‡∏¥‡πâ‡∏ô</div>
                        </div>
                        <div>
                            <div class="text-gray-600">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ: <span class="font-medium">${product.revenue.toLocaleString()}</span> ‡∏ö‡∏≤‡∏ó</div>
                            <div class="text-gray-600">‡∏Å‡∏≥‡πÑ‡∏£: <span class="font-medium ${product.profit >= 0 ? 'text-green-600' : 'text-red-600'}">${product.profit.toLocaleString()}</span> ‡∏ö‡∏≤‡∏ó</div>
                        </div>
                    </div>
                    
                    <!-- Progress bar for sell rate -->
                    <div class="mt-3">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="h-2 rounded-full ${product.sellRate >= 80 ? 'bg-green-500' : product.sellRate >= 50 ? 'bg-yellow-500' : 'bg-red-500'}" 
                                 style="width: ${Math.min(product.sellRate, 100)}%"></div>
                        </div>
                    </div>
                </div>
            `).join('') || '<div class="text-gray-500 text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
        }
        
        function updateSalesSummary(salesData) {
            const totalTransactions = salesData.length;
            const totalItems = salesData.reduce((sum, sale) => sum + sale.quantity, 0);
            const avgTransactionValue = totalTransactions > 0 ? (salesData.reduce((sum, sale) => sum + sale.revenue, 0) / totalTransactions) : 0;
            
            // Group by product
            const productSales = {};
            salesData.forEach(sale => {
                if (!productSales[sale.productName]) {
                    productSales[sale.productName] = { quantity: 0, revenue: 0, transactions: 0 };
                }
                productSales[sale.productName].quantity += sale.quantity;
                productSales[sale.productName].revenue += sale.revenue;
                productSales[sale.productName].transactions += 1;
            });
            
            const topProducts = Object.entries(productSales)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 5);
            
            const container = document.getElementById('salesSummary');
            container.innerHTML = `
                <div class="bg-white p-4 rounded-lg border mb-4">
                    <div class="font-semibold mb-3">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <div class="text-gray-600">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢: <span class="font-medium">${totalTransactions}</span></div>
                            <div class="text-gray-600">‡∏ä‡∏¥‡πâ‡∏ô‡∏£‡∏ß‡∏°: <span class="font-medium">${totalItems}</span></div>
                        </div>
                        <div>
                            <div class="text-gray-600">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: <span class="font-medium">${avgTransactionValue.toFixed(0)}</span> ‡∏ö‡∏≤‡∏ó</div>
                            <div class="text-gray-600">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢: <span class="font-medium">${Object.keys(productSales).length}</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-lg border">
                    <div class="font-semibold mb-3">üèÜ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</div>
                    <div class="space-y-2">
                        ${topProducts.map(([name, data], index) => `
                            <div class="flex justify-between items-center py-2 ${index < topProducts.length - 1 ? 'border-b' : ''}">
                                <div>
                                    <div class="font-medium">${index + 1}. ${name}</div>
                                    <div class="text-sm text-gray-600">${data.quantity} ‡∏ä‡∏¥‡πâ‡∏ô, ${data.transactions} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-semibold text-green-600">${data.revenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` || '<div class="text-gray-500 text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
        }
        
        function updateProductionVsSales(salesData, productionData) {
            // Group production by product
            const productionByProduct = {};
            productionData.forEach(prod => {
                if (!productionByProduct[prod.productName]) {
                    productionByProduct[prod.productName] = { quantity: 0, cost: 0 };
                }
                productionByProduct[prod.productName].quantity += prod.quantity;
                productionByProduct[prod.productName].cost += prod.totalCost;
            });
            
            // Group sales by product
            const salesByProduct = {};
            salesData.forEach(sale => {
                if (!salesByProduct[sale.productName]) {
                    salesByProduct[sale.productName] = { quantity: 0, revenue: 0 };
                }
                salesByProduct[sale.productName].quantity += sale.quantity;
                salesByProduct[sale.productName].revenue += sale.revenue;
            });
            
            // Combine data
            const allProducts = new Set([...Object.keys(productionByProduct), ...Object.keys(salesByProduct)]);
            const comparisonData = Array.from(allProducts).map(productName => {
                const production = productionByProduct[productName] || { quantity: 0, cost: 0 };
                const sales = salesByProduct[productName] || { quantity: 0, revenue: 0 };
                const remaining = production.quantity - sales.quantity;
                const sellRate = production.quantity > 0 ? ((sales.quantity / production.quantity) * 100) : 0;
                
                return {
                    name: productName,
                    produced: production.quantity,
                    sold: sales.quantity,
                    remaining: remaining,
                    sellRate: sellRate,
                    productionCost: production.cost,
                    salesRevenue: sales.revenue
                };
            }).sort((a, b) => b.produced - a.produced);
            
            const container = document.getElementById('productionVsSales');
            container.innerHTML = comparisonData.map(product => `
                <div class="bg-white p-4 rounded-lg border">
                    <div class="flex justify-between items-center mb-3">
                        <div class="font-semibold text-gray-800">${product.name}</div>
                        <div class="text-sm ${product.sellRate >= 80 ? 'text-green-600' : product.sellRate >= 50 ? 'text-yellow-600' : 'text-red-600'}">
                            ‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ ${product.sellRate.toFixed(1)}%
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4 text-center text-sm mb-3">
                        <div class="bg-blue-50 p-2 rounded">
                            <div class="font-bold text-blue-600">${product.produced}</div>
                            <div class="text-blue-600">‡∏ú‡∏•‡∏¥‡∏ï</div>
                        </div>
                        <div class="bg-green-50 p-2 rounded">
                            <div class="font-bold text-green-600">${product.sold}</div>
                            <div class="text-green-600">‡∏Ç‡∏≤‡∏¢</div>
                        </div>
                        <div class="bg-gray-50 p-2 rounded">
                            <div class="font-bold text-gray-600">${product.remaining}</div>
                            <div class="text-gray-600">‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="text-gray-600">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ú‡∏•‡∏¥‡∏ï: <span class="font-medium">${product.productionCost.toLocaleString()}</span> ‡∏ö‡∏≤‡∏ó</div>
                        <div class="text-gray-600">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ç‡∏≤‡∏¢: <span class="font-medium">${product.salesRevenue.toLocaleString()}</span> ‡∏ö‡∏≤‡∏ó</div>
                    </div>
                    
                    <!-- Visual progress bar -->
                    <div class="mt-3">
                        <div class="flex text-xs text-gray-600 mb-1">
                            <span>‡∏Ç‡∏≤‡∏¢</span>
                            <span class="ml-auto">‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div class="h-full bg-green-500 float-left" style="width: ${product.sellRate}%"></div>
                            <div class="h-full bg-gray-400" style="width: ${100 - product.sellRate}%"></div>
                        </div>
                    </div>
                </div>
            `).join('') || '<div class="text-gray-500 text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
        }
        
        function updateDailyBreakdown(salesData, productionData) {
            const container = document.getElementById('dailyBreakdown');
            const contentContainer = document.getElementById('dailyBreakdownContent');
            
            // Only show daily breakdown for week and month periods
            if (currentReportPeriod === 'today') {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            
            // Group data by date
            const dailyData = {};
            
            // Process sales data
            salesData.forEach(sale => {
                const date = new Date(sale.date).toDateString();
                if (!dailyData[date]) {
                    dailyData[date] = { sales: 0, revenue: 0, profit: 0, production: 0, productionCost: 0 };
                }
                dailyData[date].sales += sale.quantity;
                dailyData[date].revenue += sale.revenue;
                dailyData[date].profit += sale.profit;
            });
            
            // Process production data
            productionData.forEach(prod => {
                const date = new Date(prod.date).toDateString();
                if (!dailyData[date]) {
                    dailyData[date] = { sales: 0, revenue: 0, profit: 0, production: 0, productionCost: 0 };
                }
                dailyData[date].production += prod.quantity;
                dailyData[date].productionCost += prod.totalCost;
            });
            
            // Sort by date (newest first)
            const sortedDates = Object.keys(dailyData).sort((a, b) => new Date(b) - new Date(a));
            
            contentContainer.innerHTML = sortedDates.map(dateString => {
                const data = dailyData[dateString];
                const date = new Date(dateString);
                const thaiDate = date.toLocaleDateString('th-TH', { 
                    weekday: 'short',
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                return `
                    <div class="bg-white p-3 rounded-lg border">
                        <div class="font-semibold text-gray-800 mb-2">${thaiDate}</div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                            <div class="text-center">
                                <div class="font-bold text-blue-600">${data.production}</div>
                                <div class="text-blue-600">‡∏ú‡∏•‡∏¥‡∏ï (‡∏ä‡∏¥‡πâ‡∏ô)</div>
                            </div>
                            <div class="text-center">
                                <div class="font-bold text-green-600">${data.sales}</div>
                                <div class="text-green-600">‡∏Ç‡∏≤‡∏¢ (‡∏ä‡∏¥‡πâ‡∏ô)</div>
                            </div>
                            <div class="text-center">
                                <div class="font-bold text-green-600">${data.revenue.toLocaleString()}</div>
                                <div class="text-green-600">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)</div>
                            </div>
                            <div class="text-center">
                                <div class="font-bold ${data.profit >= 0 ? 'text-green-600' : 'text-red-600'}">${data.profit.toLocaleString()}</div>
                                <div class="${data.profit >= 0 ? 'text-green-600' : 'text-red-600'}">‡∏Å‡∏≥‡πÑ‡∏£ (‡∏ö‡∏≤‡∏ó)</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('') || '<div class="text-gray-500 text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
        }

        // Daily Reset Functions
        function checkDailyReset() {
            const lastResetDate = localStorage.getItem('lastResetDate');
            const today = new Date();
            const resetTime = new Date(today);
            resetTime.setHours(5, 0, 0, 0); // 5:00 AM
            
            // If current time is before 5 AM, check against yesterday's reset
            if (today.getHours() < 5) {
                resetTime.setDate(resetTime.getDate() - 1);
            }
            
            const resetTimeString = resetTime.toDateString();
            
            if (!lastResetDate || lastResetDate !== resetTimeString) {
                performDailyReset();
                localStorage.setItem('lastResetDate', resetTimeString);
            }
        }
        
        function performDailyReset() {
            // Clear finished products (production reset)
            finishedProducts = [];
            
            // Keep ingredients, recipes, sales history, and purchase history
            // Only reset the production inventory
            
            saveData();
            console.log('üîÑ Daily reset performed at', new Date().toLocaleString('th-TH'));
            
            // Show notification if user is active
            if (document.visibilityState === 'visible') {
                alert('üåÖ ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (5:00 ‡∏ô.)\n‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà!');
            }
        }
        
        function startDailyResetTimer() {
            // Update countdown display every minute
            function updateCountdown() {
                const countdownElement = document.getElementById('resetCountdown');
                if (countdownElement) {
                    countdownElement.textContent = `‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ${formatTimeUntilReset()}`;
                }
            }
            
            // Initial update
            updateCountdown();
            
            // Check every second for reset time and update countdown every minute
            setInterval(() => {
                const now = new Date();
                
                // Update countdown every minute (when seconds = 0)
                if (now.getSeconds() === 0) {
                    updateCountdown();
                }
                
                // Check for reset time
                if (now.getHours() === 5 && now.getMinutes() === 0 && now.getSeconds() === 0) {
                    checkDailyReset();
                    updateAllDisplays();
                    updateCountdown(); // Update countdown after reset
                }
            }, 1000);
        }
        
        function getNextResetTime() {
            const now = new Date();
            const nextReset = new Date(now);
            nextReset.setHours(5, 0, 0, 0);
            
            // If it's already past 5 AM today, set for tomorrow
            if (now.getHours() >= 5) {
                nextReset.setDate(nextReset.getDate() + 1);
            }
            
            return nextReset;
        }
        
        function formatTimeUntilReset() {
            const now = new Date();
            const nextReset = getNextResetTime();
            const diff = nextReset - now;
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            return `${hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        }

        // Data persistence
        function saveData() {
            localStorage.setItem('ingredients', JSON.stringify(ingredients));
            localStorage.setItem('recipes', JSON.stringify(recipes));
            localStorage.setItem('finishedProducts', JSON.stringify(finishedProducts));
            localStorage.setItem('sales', JSON.stringify(sales));
            localStorage.setItem('purchases', JSON.stringify(purchases));
            localStorage.setItem('productionHistory', JSON.stringify(productionHistory));
        }

        function updateAllDisplays() {
            updateIngredientsDisplay();
            updateInventoryDisplay();
            updateRecipesDisplay();
            updateFinishedProductsDisplay();
            updateSalesHistory();
            updateRecipeSelects();
            updateProductionSelects();
            updateSalesSelects();
        }

        // Price per unit calculation
        function updatePricePerUnit() {
            const purchaseQuantity = parseFloat(document.getElementById('ingredientQuantity').value) || 0;
            const totalPrice = parseFloat(document.getElementById('ingredientTotalPrice').value) || 0;
            const unit = document.getElementById('ingredientUnit').value;
            const purchaseUnit = document.getElementById('ingredientPurchaseUnit').value;
            const conversionRate = parseFloat(document.getElementById('ingredientConversionRate').value) || 1;
            
            if (purchaseQuantity > 0 && totalPrice > 0 && conversionRate > 0) {
                const actualQuantity = purchaseQuantity * conversionRate;
                const pricePerUnit = totalPrice / actualQuantity;
                const pricePerPurchaseUnit = totalPrice / purchaseQuantity;
                
                document.getElementById('pricePerUnit').innerHTML = `
                    <div class="space-y-1">
                        <div class="font-semibold text-blue-600">
                            ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠${unit || '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö'}: ${pricePerUnit.toFixed(4)} ‡∏ö‡∏≤‡∏ó
                        </div>
                        ${purchaseUnit ? `
                            <div class="text-sm text-gray-600">
                                ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠${purchaseUnit}: ${pricePerPurchaseUnit.toFixed(2)} ‡∏ö‡∏≤‡∏ó
                            </div>
                            <div class="text-sm text-gray-600">
                                ${purchaseQuantity} ${purchaseUnit} = ${actualQuantity} ${unit}
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                document.getElementById('pricePerUnit').innerHTML = '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà';
            }
        }

        // Auto-update production preview when pieces change
        document.getElementById('productionPieces').addEventListener('input', updateProductionPreview);
        document.getElementById('remainingQuantity').addEventListener('input', updateSalePreview);
        document.getElementById('salePrice').addEventListener('input', updateSalePreview);
        
        // Auto-calculate price per unit
        document.getElementById('ingredientQuantity').addEventListener('input', updatePricePerUnit);
        document.getElementById('ingredientTotalPrice').addEventListener('input', updatePricePerUnit);
        document.getElementById('ingredientUnit').addEventListener('input', updatePricePerUnit);
        document.getElementById('ingredientPurchaseUnit').addEventListener('input', updatePricePerUnit);
        document.getElementById('ingredientConversionRate').addEventListener('input', updatePricePerUnit);
        
        // Auto-update purchase preview
        document.getElementById('purchaseQuantity').addEventListener('input', updatePurchasePreview);
        
        // Auto-update reports when custom dates change
        document.getElementById('startDate').addEventListener('change', function() {
            if (currentReportPeriod === 'custom') {
                updateReportPeriodText();
                updateReports();
            }
        });
        
        document.getElementById('endDate').addEventListener('change', function() {
            if (currentReportPeriod === 'custom') {
                updateReportPeriodText();
                updateReports();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'986f93fe153bd03c',t:'MTc1OTE5MTg3NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
